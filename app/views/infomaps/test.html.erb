<!DOCTYPE html>
<html ng-app="crfloodweb">
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.5/angular.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>
    <script src="http://tombatossals.github.io/angular-leaflet-directive/dist/angular-leaflet-directive.min.js"></script>
    <!-- Highchart-->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.css" />

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  
    <script>
        var getJson = setInterval(myTimer, 3600000);

        function myTimer() {
            $.ajax({
            type: "GET",
            url: 'storages/getjson'})
            .done(function(data){ 
              console.log("Get Url Json Success")
            })           
                .error(function(jqXHR, textStatus, errorThrown) {
                  alert("Error=" + errorThrown);
                });
          }
    </script>
    <script>


        var app = angular.module("crfloodweb", ['leaflet-directive']);
        app.controller("MapController", [ "$scope", function($scope) {
        
        $scope.center = {
              lat: 19.9088,
              lng: 99.83414,
              zoom: 12
        };
        $scope.dataTypes = ["ค่าทั่วไป", "ค่าสูงสุด", "ค่าต่ำสุด","ค่าเฉลี่ย","จำนวนครั้ง"];

        $scope.$on("leafletDirectiveMap.click", function(event, args)
        {

          // console.log($scope.startDate);

          var e = args.leafletEvent;
          var lat = e.latlng.lat.toString();
          var lng = e.latlng.lng.toString();
          var data = { 
            "lat":lat,
            "lng":lng,
            "startDate":$scope.startDate,
            "finalDate":$scope.finalDate
          };            
          // console.log(data);
          $.ajax({
          method : "GET",
          url : "infomaps/point",
          data : data
          }).then(function mySucces(response) {
              $scope.jsonData = angular.fromJson(response);
              console.log($scope.jsonData);
              
              if($scope.jsonData != undefined){
                if($scope.jsonData.flooddata.temperatare == null){
                  var numTemperatare = "สถานีนี้ไม่สามารถอ่านค่าอุณหภูมิ";
                 
                } 
                else{
                  var numTemperatare = $scope.jsonData.flooddata.temperatare;
                  
                }
                if($scope.jsonData.maxlevel != null){              
                  $scope.markers = [{
                    lat: $scope.jsonData.lat*1,
                    lng: $scope.jsonData.lng*1,
                    focus: false,
                    message: "ชื่อสถานี:"+$scope.jsonData.flooddata.name_station+"<br>ระดับน้ำ:"+$scope.jsonData.flooddata.water_level+"<br>ระดับน้ำวิกฤต:"+$scope.jsonData.flooddata.critical_level+"<br>อุณหภูมิ:"+numTemperatare+"<br>ค่าสูงสุด:"+$scope.jsonData.maxlevel+"<br>ค่าต่ำสุด:"+$scope.jsonData.minlevel+"<br>ค่าเฉลี่ย:"+$scope.jsonData.avglevel+"<br>จำครั้งที่เกิดฝน:"+$scope.jsonData.sumrain+"<br>จำนวนครั้งที่เกิดน้ำท่วม:"+$scope.jsonData.sumflood,
                    icon: null
                  }];
                  
                  var xCategories =[];
                  var yWaterLevel =[];
                  var yTemperatara =[];

                  for(var i=0; i<$scope.jsonData.fullData.length ;i++){
                    xCategories[i] = $scope.jsonData.fullData[i].time;
                    yWaterLevel[i] = $scope.jsonData.fullData[i].water_level;
                    yTemperatara[i] = $scope.jsonData.fullData[i].temperatare;
                  };
                  
                   Highcharts.chart('mychart', {
                      title: {
                          text: $scope.jsonData.flooddata.name_station
                      },

                      xAxis: {
                          categories: xCategories
                      },

                      series: [{
                          name: 'ระดับน้ำ',
                          data: yWaterLevel
                      },{
                          name: 'อุณหภูมิ',
                          data: yTemperatara
                      }]
                    
                  });
                }
                else{
                    $scope.markers = [{
                    lat: $scope.jsonData.lat*1,
                    lng: $scope.jsonData.lng*1,
                    focus: false,
                    message: "ชื่อสถานี:"+$scope.jsonData.flooddata.name_station+"<br>ระดับน้ำ:"+$scope.jsonData.flooddata.water_level+"<br>ระดับน้ำวิกฤต:"+$scope.jsonData.flooddata.critical_level+"<br>อุณหภูมิ:"+numTemperatare
                  }];
                }         
              }
              else{               
                alert("บริเวณนี้ไม่มีข้อมูล");
              }
              
          }, function myError(response) {
              $scope.myWelcome = response.statusText;
          });          
        });
       
      }]);
         
    </script>
  </head>
  <body ng-controller="MapController">
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <!-- <select ng-model="type">
        <option ng-repeat="x in dataTypes">{{x}}</option>
        </select> -->
        <input type="date" name="startDate" ng-model="startDate">
        <input type="date" name="finalDate" ng-model="finalDate">
        <div id="mychart"></div>

      </div>
      <div class="col-md-8">
        <div style="width: 100%; height: 550px; margin: 0px ;float:right;">
          <leaflet lf-center="center" 
                    style="width:100%; height:100%;"
                    markers="markers">
                      
          </leaflet>
        </div>    
      </div>
    </div>
    
  </div>

</div>
  </body>
</html>



